<!DOCTYPE html>
<html>
  <head>
    <title>Events Management - Book in</title>

    <!-- Viewport mobile tag for sensible mobile support -->
    <!-- meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--STYLES-->
    <link rel="stylesheet" href="/styles/angular-deckgrid.css">
    <link rel="stylesheet" href="/styles/angular-toastr.css">
    <link rel="stylesheet" href="/styles/bootstrap.3.1.1.css">
    <link rel="stylesheet" href="/styles/events.css">
    <link rel="stylesheet" href="/styles/forMobileIE.css">
    <link rel="stylesheet" href="/styles/importer.css">
    <link rel="stylesheet" href="/styles/ng-dialog/myth/ngDialog-theme-default.css">
    <link rel="stylesheet" href="/styles/ng-dialog/myth/ngDialog-theme-plain.css">
    <link rel="stylesheet" href="/styles/ng-dialog/myth/ngDialog.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog-custom-width.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog-theme-default.min.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog-theme-plain.min.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog.min.css">
    <!--STYLES END-->

    <!--Added this so the client has access to the csrf tag and it's grabbed first service side on every page -->
    <script type="text/javascript">
    window.SAILS_LOCALS = {
      _csrf: "<%= _csrf %>",
      user: <%- JSON.stringify(res.locals.user) %>,
      event: <%- JSON.stringify(res.locals.event) %>,
      booking: <%- (res.locals.booking)?JSON.stringify(res.locals.booking):"{}" %>,
      myBookings: <%- res.locals.myBookings %>,
      eventBookings: <%- res.locals.eventBookings %>,
      mode: "<%= mode.toLowerCase() %>",
    };
    
    </script>
    
  </head>

  <body ng-app="EventsModule" data-ng-controller="BookController" ng-cloak>
    
                     
    <div class="container-fluid">
       
      <% include partials/private/navbar.ejs %> 
        
              

      <!-- BOOKING FORM --> 
      <form ng-submit="submitBookingForm()" id="booking-up-form" name="booking" 
          ng-class="{'form-signin':'<%- req.device.type %>'=='desktop'}">
        <h3 class="form-signin-heading">Booking for {{event.name}}</h3>
        <h4>{{ event.date | date : 'EEE, MMM dd, yyyy'}} at {{event.time}}</h4>
        <h4>{{event.venue}}<h4>
        <h5>Price per place: Â£{{event.price.toFixed(2)}}</h5>
        <h5>Places remaining: {{event.capacity}}</h5>  
        <h5>Organiser: {{event.organiser.name}} (<a href="mailto:{{event.organiser.email}}" target="_top">{{event.organiser.email}}</a>)</h5>     
        <h3 ng-hide="event.capacity>0">THIS EVENT IS FULLY BOOKED</h3>     
        <h3 ng-hide="eventBookings || !existingBooking || myBookings">YOU HAVE ALREADY BOOKED IN {{paidMsg}}</h3> 
        <h3 ng-show="myBookings && paid">YOU HAVE ALREADY PAID FOR THIS BOOKING</h3> 
        <h4 ng-show="!eventBookings && paid && mode!='delete'"><i>Please contact the organiser to make changes</i></h4>      
        <h4 ng-show="!eventBookings && paid && mode=='delete'"><i>You have already paid. Please contact the organiser to cancel this booking</i></h4>       
        <h5 ng-hide="event.capacity<=0">Items marked with * are mandatory</h5>  
        <div class="row" ng-hide="event.capacity<=0 && !myBookings && !eventBookings" disable-contents="(!eventBookings && paid) || mode=='delete'">  <!-- disable-contents is a custom directive I have added to EventsModule -->
           
           <% include partials/bookingDetails.ejs %>  
          
        </div>  
  
        <br/>
  
        <!-- Disable button until something has been edited and the form has no errors -->
        <button class="btn btn-primary btn-lg btn-block" type="submit" ng-disabled="booking.$invalid || !detailsComplete() || bookingForm.loading || (!eventBookings && paid)">
          <span ng-show="!bookingForm.loading && mode=='delete'">Cancel booking</span>
          <span ng-show="!bookingForm.loading && !existingBooking && mode!='delete'">Book now</span>
          <span ng-show="!bookingForm.loading && existingBooking && mode!='delete'">Update booking</span>
          <span class="overlord-loading-spinner fa fa-spinner" ng-show="bookingForm.loading" ></span>
          <span ng-show="bookingForm.loading && !existingBooking  && mode!='delete'">Making your booking...</span>
          <span ng-show="bookingForm.loading && existingBooking  && mode!='delete'">Updating your booking...</span>
          <span ng-show="bookingForm.loading && mode=='delete'">Cancelling your booking...</span>
        </button>
  
        <input type="hidden" name="_csrf" value="<%= _csrf %>" />
      </form>
     
     </div>  

    <% include partials/public/footer.ejs %>   
      
    <!--SCRIPTS-->
    <script src="/js/dependencies/sails.io.js"></script>
    <script src="/js/dependencies/jquery/jquery.js"></script>
    <script src="/js/dependencies/angular.js"></script>
    <script src="/js/dependencies/angular-deckgrid.js"></script>
    <script src="/js/dependencies/angular-initial-value.min.js"></script>
    <script src="/js/dependencies/angular-toastr.js"></script>
    <script src="/js/dependencies/compareTo.module.js"></script>
    <script src="/js/dependencies/forMobileIE.js"></script>
    <script src="/js/dependencies/ngDialog.min.js"></script>
    <script src="/js/dependencies/ui-bootstrap-tpls-0.13.0.min.js"></script>
    <script src="/js/EventsModule.js"></script>
    <script src="/js/private/BookController.js"></script>
    <script src="/js/private/BookingsController.js"></script>
    <script src="/js/private/DashboardController.js"></script>
    <script src="/js/private/EventDetailsController.js"></script>
    <script src="/js/private/EventsController.js"></script>
    <script src="/js/private/ProfileController.js"></script>
    <script src="/js/private/UserDetailsController.js"></script>
    <script src="/js/private/UsersController.js"></script>
    <script src="/js/public/HomepageController.js"></script>
    <script src="/js/public/ResetController.js"></script>
    <script src="/js/public/SignupController.js"></script>
    <!--SCRIPTS END-->
  </body>
</html>
