<!DOCTYPE html>
<html>
  <head>
    <title><%= sails.config.events.title %> - Book in</title>

    <!-- Viewport mobile tag for sensible mobile support -->
    <!-- meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="http://addtocalendar.com/atc/1.5/atc-style-button-icon.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!--STYLES-->
    <link rel="stylesheet" href="/styles/angular-deckgrid.css">
    <link rel="stylesheet" href="/styles/angular-toastr.css">
    <link rel="stylesheet" href="/styles/bootstrap.3.1.1.css">
    <link rel="stylesheet" href="/styles/events.css">
    <link rel="stylesheet" href="/styles/forMobileIE.css">
    <link rel="stylesheet" href="/styles/importer.css">
    <link rel="stylesheet" href="/styles/ng-dialog/myth/ngDialog-theme-default.css">
    <link rel="stylesheet" href="/styles/ng-dialog/myth/ngDialog-theme-plain.css">
    <link rel="stylesheet" href="/styles/ng-dialog/myth/ngDialog.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog-custom-width.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog-theme-default.min.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog-theme-plain.min.css">
    <link rel="stylesheet" href="/styles/ng-dialog/ngDialog.min.css">
    <!--STYLES END-->

    <!--Added this so the client has access to the csrf tag and it's grabbed first service side on every page -->
    <script type="text/javascript">
    window.SAILS_LOCALS = {
      _csrf: "<%= _csrf %>",
      user: <%- JSON.stringify(res.locals.user) %>,
      event: <%- JSON.stringify(res.locals.event) %>,
      booking: <%- (res.locals.booking)?JSON.stringify(res.locals.booking):"{}" %>,
      myBookings: <%- res.locals.myBookings %>,
      eventBookings: <%- res.locals.eventBookings %>,
      mode: "<%= mode.toLowerCase() %>",
      mops: <%- JSON.stringify(res.locals.mops) %>,
      salutations: <%- JSON.stringify(res.locals.salutations) %>,
      areas: <%- JSON.stringify(res.locals.areas) %>,
      lodgeMandatory: <%- res.locals.lodgeMandatory %>,
      selectedUserId: <%- JSON.stringify(res.locals.selectedUserId) %>,
      potentialDuplicates: <%- JSON.stringify(res.locals.potentialDuplicates)%>,
    };
    
    </script>
        
  </head>

  <body ng-app="EventsModule" data-ng-controller="BookController" ng-cloak>
     
        
                     
    <div class="container-fluid">
       
      <% include partials/private/navbar.ejs %> 
        
              

      <!-- BOOKING FORM --> 
      <form ng-submit="submitBookingForm()" id="booking-up-form" name="booking" 
          ng-class="{'form-signin':'<%- req.device.type %>'=='desktop'}">
        
        <h3 class="form-signin-heading"><span ng-hide="event.regInterest">Booking</span><span ng-show="event.regInterest">Interest</span> for {{event.name}}</h3>
        <h4>{{ event.date | date : 'EEE, MMM dd, yyyy'}} at {{event.time}}</h4>
        <h4>{{event.venue}}<h4>        
        
        <h4><span class="addtocalendar atc-style-icon atc-style-menu-wb" id="atc_icon_calbw1" data-on-button-click="" data-on-calendar-click="tidyCalendarEvent">
              <!-- Addtocalendar link -->
              <a class="atcb-link" tabindex="1" id="atc_icon_calbw1_link" title="Add to calendar">
                <span class="fa fa-calendar-plus-o"></span> Add to calendar   
              </a>               
              <var class="atc_event">
                  <var class="atc_date_start">{{ event.date | date : 'yyyy-MM-dd'}} {{event.time}}</var>
                  <var class="atc_date_end">{{ event.date | date : 'yyyy-MM-dd'}} 23:59:00</var>
                  <var class="atc_timezone">Europe/London</var>
                  <var class="atc_title">{{event.name}}</var>
                  <var class="atc_description">{{event.blurb}}</var>
                  <var class="atc_location">{{event.venue}}</var>
                  <var class="atc_organizer">{{event.organiser.name}}</var>
                  <var class="atc_organizer_email">{{event.organiser.email}}</var>                         
              </var>
          </span>
        </h4> 
          
        <h5 ng-hide="event.free">Price per place: Â£{{event.price.toFixed(2)}}</h5>
        <h5 ng-hide="event.regInterest">Places remaining: {{event.capacity}}</h5>  
        
        <h4>In case of difficulty, contact:<h4>  
        <h5><a href="mailto:{{event.organiser.email}}?Subject={{event.name}}: {{ event.date | date : 'EEE, MMM dd, yyyy'}} at {{event.time}}" target="_top">
              <span class="fa fa-envelope"></span> Organiser: {{event.organiser.name}}
            </a>
        </h5>          
        <h5 ng-hide="!event.organiser.phone"><a href="tel:{{event.organiser.phone}}"><span class="fa fa-phone"></span> {{event.organiser.phone}}</a></h5>
        <h3 ng-hide="event.capacity>0">THIS EVENT IS FULLY BOOKED</h3>     
        <h3 ng-hide="eventBookings || userBookings || !existingBooking || myBookings || mode=='delete'"><span ng-hide="event.regInterest">YOU HAVE ALREADY BOOKED IN {{paidMsg}}</span><span ng-show="event.regInterest">YOU HAVE ALREADY REGISTERED INTEREST {{paidMsg}}</span></h3> 
        <h3 ng-show="myBookings && paid">YOU HAVE ALREADY PAID FOR THIS BOOKING</h3> 
        <h4 ng-show="!eventBookings && !userBookings && !openForBookings">NOT OPEN FOR <span ng-hide="event.regInterest">BOOKINGS</span><span ng-show="event.regInterest">REGISTRATION</span> UNTIL {{ event.openingDate | date : 'EEE, MMM dd, yyyy'}}</h4>      
        <h4 ng-show="!user.isAdmin && !user.isOrganiser && !eventBookings && !userBookings && paid && mode!='delete'"><i>Contact the organiser to amend the number of places booked</i></h4>      
        <h4 ng-show="!eventBookings && !userBookings && paid && mode=='delete'"><i>You have already paid. Please contact the organiser to cancel this booking</i></h4>
        <h4 ng-show="(eventBookings || userBookings) && bookingForm.remindersSent && bookingForm.remindersSent>0"><b>PAYMENT REMINDERS SENT: {{bookingForm.remindersSent}}</b></h4>           
        <h5 ng-show="existingBooking && !paid">Payment deadline: <b>{{ deadline }}</b></h5> 
        <h5 ng-show="event.additionalInfo">
            <a href="{{event.additionalInfo}}" target="_blank">
              <span class="fa fa-info-circle"></span> Additional event info
            </a>
        </h5>         
        <h5 ng-hide="event.capacity<=0">Items marked with * are mandatory</h5>  
        
        <div class="row" ng-hide="event.capacity<=0 && !user.isAdmin && !user.isOrganiser && !myBookings && !eventBookings && !userBookings" disable-contents="mode=='delete' || !openForBookings">  <!-- disable-contents is a custom directive I have added to EventsModule -->
           
           <% include partials/bookingDetails.ejs %>  
          
        </div>  
  
        <br/>
  
        <!-- Disable button until something has been edited and the form has no errors --> 
        <!--
        <button class="btn btn-primary btn-lg btn-block" type="submit" ng-disabled="(mode!='delete' && (booking.$invalid || !detailsComplete())) || (!eventBookings && !userBookings && paid) || bookingForm.loading">
        -->

        <button class="btn btn-primary btn-lg btn-block" type="button" ng-click="addGuest()" ng-show="(openForBookings && bookingForm.places<placesMax && mode!='delete')">
          <span>Add guest</span>     
        </button>

        <button class="btn btn-primary btn-lg btn-block" type="submit" ng-disabled="bookingForm.loading || event.capacity<=0 || !openForBookings">
          <span ng-show="!bookingForm.loading && mode=='delete' && !event.regInterest">Cancel booking</span>
          <span ng-show="!bookingForm.loading && mode=='delete' && event.regInterest">Cancel interest</span>
          <span ng-show="!bookingForm.loading && !existingBooking && mode!='delete' && !event.regInterest">Book now</span>
          <span ng-show="!bookingForm.loading && !existingBooking && mode!='delete' && event.regInterest">Register interest</span>
          <span ng-show="!bookingForm.loading && existingBooking && mode!='delete' && !event.regInterest">Update booking</span>
          <span ng-show="!bookingForm.loading && existingBooking && mode!='delete' && event.regInterest">Update interest</span>
          <span class="fa-pulse fa fa-spinner" ng-show="bookingForm.loading" ></span>
          <span ng-show="bookingForm.loading && !existingBooking  && mode!='delete'">Creating...</span>
          <span ng-show="bookingForm.loading && existingBooking  && mode!='delete'">Updating...</span>
          <span ng-show="bookingForm.loading && mode=='delete'">Cancelling...</span>
        </button>

        <button class="btn btn-primary btn-lg btn-block" type="button" ng-click="transferBooking()" ng-show="(mode!='delete' && mode!='create' && selectedUserId)">
          <span ng-show="!bookingForm.transferring">Transfer booking</span>  
          <span ng-show="bookingForm.transferring">Transferring booking...</span>          
        </button>
  
        <input type="hidden" name="_csrf" value="<%= _csrf %>" />
      </form>
     
     </div>  


    <% include partials/public/footer.ejs %>   
      
      
    
     
    <!-- addtocalendar code -->
    <script>
      function tidyCalendarEvent(mouseEvent){
        // We cannot have the extra angularjs classes in the data or it will not work
        $(".atcb-item").find("a").each(function(){
          var $this=$(this);
          var href=$this.attr("href");
          href=href.replace(RegExp(" ng-binding","g"),"");
          $this.attr("href",href);
        })          
      }
       
    </script>  
    <script type="text/javascript">(function () {
          if (window.addtocalendar)if(typeof window.addtocalendar.start == "function")return;
          if (window.ifaddtocalendar == undefined) { window.ifaddtocalendar = 1;
              var d = document, s = d.createElement('script'), g = 'getElementsByTagName';
              s.type = 'text/javascript';s.charset = 'UTF-8';s.async = true;
              s.src = ('https:' == window.location.protocol ? 'https' : 'http')+'://addtocalendar.com/atc/1.5/atc.min.js';
              var h = d[g]('body')[0];h.appendChild(s); }})();
    </script>
  
      
    <!--SCRIPTS-->
    <script src="/js/dependencies/sails.io.js"></script>
    <script src="/js/dependencies/jquery/jquery.js"></script>
    <script src="/js/dependencies/angular.js"></script>
    <script src="/js/dependencies/angular-deckgrid.js"></script>
    <script src="/js/dependencies/angular-initial-value.min.js"></script>
    <script src="/js/dependencies/angular-toastr.js"></script>
    <script src="/js/dependencies/compareTo.module.js"></script>
    <script src="/js/dependencies/forMobileIE.js"></script>
    <script src="/js/dependencies/ngDialog.min.js"></script>
    <script src="/js/dependencies/ui-bootstrap-tpls-0.14.3.min.js"></script>
    <script src="/js/EventsModule.js"></script>
    <script src="/js/private/ApologiesController.js"></script>
    <script src="/js/private/ApologyController.js"></script>
    <script src="/js/private/BookController.js"></script>
    <script src="/js/private/BookingsController.js"></script>
    <script src="/js/private/DashboardController.js"></script>
    <script src="/js/private/EventDetailsController.js"></script>
    <script src="/js/private/EventsController.js"></script>
    <script src="/js/private/ProfileController.js"></script>
    <script src="/js/private/UserBookingsController.js"></script>
    <script src="/js/private/UserDetailsController.js"></script>
    <script src="/js/private/UsersController.js"></script>
    <script src="/js/public/HomepageController.js"></script>
    <script src="/js/public/ResetController.js"></script>
    <script src="/js/public/SignupController.js"></script>
    <!--SCRIPTS END-->
  </body>
</html>
